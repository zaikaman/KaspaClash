openapi: 3.0.3
info:
  title: KaspaClash API
  description: REST API for KaspaClash multiplayer fighting game
  version: 1.0.0
  contact:
    name: KaspaClash Team

servers:
  - url: /api
    description: Next.js API routes

tags:
  - name: Matchmaking
    description: Room creation, joining, and queue management
  - name: Game
    description: Match state and move submission
  - name: Relayer
    description: Sponsored transaction service
  - name: Leaderboard
    description: Rankings and match history
  - name: Players
    description: Player profiles and stats

paths:
  # ============================================================================
  # MATCHMAKING
  # ============================================================================
  
  /matchmaking/queue:
    post:
      tags: [Matchmaking]
      summary: Join matchmaking queue
      description: Add player to the Quick Play queue. Returns when match is found or timeout.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [address, signature]
              properties:
                address:
                  type: string
                  example: "kaspa:qz0s..."
                  description: Player's Kaspa wallet address
                signature:
                  type: string
                  description: Signed message proving wallet ownership
      responses:
        "200":
          description: Match found
          content:
            application/json:
              schema:
                type: object
                properties:
                  matchId:
                    type: string
                    format: uuid
                  roomCode:
                    type: string
                    nullable: true
                  opponentAddress:
                    type: string
        "202":
          description: Queued, waiting for opponent
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    enum: [queued]
                  position:
                    type: integer
                  estimatedWaitSeconds:
                    type: integer
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
    
    delete:
      tags: [Matchmaking]
      summary: Leave matchmaking queue
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [address]
              properties:
                address:
                  type: string
      responses:
        "200":
          description: Left queue successfully
        "404":
          description: Not in queue

  /matchmaking/rooms:
    post:
      tags: [Matchmaking]
      summary: Create private room
      description: Create a new private room with a shareable code
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [address, signature]
              properties:
                address:
                  type: string
                signature:
                  type: string
                format:
                  type: string
                  enum: [best_of_3, best_of_5]
                  default: best_of_3
      responses:
        "201":
          description: Room created
          content:
            application/json:
              schema:
                type: object
                properties:
                  matchId:
                    type: string
                    format: uuid
                  roomCode:
                    type: string
                    pattern: "^[A-Z0-9]{6}$"
                    example: "ABC123"
                  shareUrl:
                    type: string
                    format: uri
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"

  /matchmaking/rooms/{roomCode}:
    get:
      tags: [Matchmaking]
      summary: Get room info
      parameters:
        - name: roomCode
          in: path
          required: true
          schema:
            type: string
            pattern: "^[A-Z0-9]{6}$"
      responses:
        "200":
          description: Room details
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/RoomInfo"
        "404":
          description: Room not found
    
    post:
      tags: [Matchmaking]
      summary: Join private room
      parameters:
        - name: roomCode
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [address, signature]
              properties:
                address:
                  type: string
                signature:
                  type: string
      responses:
        "200":
          description: Joined room
          content:
            application/json:
              schema:
                type: object
                properties:
                  matchId:
                    type: string
                    format: uuid
                  status:
                    type: string
                    enum: [character_select]
        "400":
          $ref: "#/components/responses/BadRequest"
        "404":
          description: Room not found
        "409":
          description: Room is full

  # ============================================================================
  # GAME
  # ============================================================================

  /matches/{matchId}:
    get:
      tags: [Game]
      summary: Get match state
      parameters:
        - name: matchId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        "200":
          description: Match details
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Match"
        "404":
          description: Match not found

  /matches/{matchId}/character:
    post:
      tags: [Game]
      summary: Select character
      description: Lock in character selection for the match
      parameters:
        - name: matchId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [address, characterId, signature]
              properties:
                address:
                  type: string
                characterId:
                  type: string
                  example: "cyber-ninja"
                signature:
                  type: string
      responses:
        "200":
          description: Character selected
          content:
            application/json:
              schema:
                type: object
                properties:
                  confirmed:
                    type: boolean
                  bothReady:
                    type: boolean
                    description: True if both players have selected
        "400":
          $ref: "#/components/responses/BadRequest"
        "404":
          description: Match not found
        "409":
          description: Character already selected or match not in character_select state

  /matches/{matchId}/move:
    post:
      tags: [Game]
      summary: Submit move (direct wallet transaction)
      description: Submit a move with the transaction ID from direct wallet signing
      parameters:
        - name: matchId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [address, moveType, txId]
              properties:
                address:
                  type: string
                moveType:
                  $ref: "#/components/schemas/MoveType"
                txId:
                  type: string
                  pattern: "^[a-f0-9]{64}$"
                  description: Kaspa transaction ID
      responses:
        "200":
          description: Move recorded
          content:
            application/json:
              schema:
                type: object
                properties:
                  moveId:
                    type: string
                    format: uuid
                  roundId:
                    type: string
                    format: uuid
                  awaitingOpponent:
                    type: boolean
        "400":
          $ref: "#/components/responses/BadRequest"
        "404":
          description: Match not found
        "409":
          description: Move already submitted for this round

  /matches/{matchId}/rounds:
    get:
      tags: [Game]
      summary: Get match rounds
      parameters:
        - name: matchId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        "200":
          description: List of rounds
          content:
            application/json:
              schema:
                type: object
                properties:
                  rounds:
                    type: array
                    items:
                      $ref: "#/components/schemas/Round"

  /matches/{matchId}/forfeit:
    post:
      tags: [Game]
      summary: Forfeit match
      parameters:
        - name: matchId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [address, signature]
              properties:
                address:
                  type: string
                signature:
                  type: string
      responses:
        "200":
          description: Match forfeited
          content:
            application/json:
              schema:
                type: object
                properties:
                  winnerAddress:
                    type: string
        "400":
          $ref: "#/components/responses/BadRequest"
        "404":
          description: Match not found

  # ============================================================================
  # RELAYER
  # ============================================================================

  /relayer/session:
    post:
      tags: [Relayer]
      summary: Start relayer session
      description: Initialize a session for sponsored transactions. Player signs once, relayer handles subsequent moves.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [address, signature, message]
              properties:
                address:
                  type: string
                signature:
                  type: string
                  description: Signature of the session message
                message:
                  type: string
                  description: "Format: 'KaspaClash Session: {timestamp}'"
      responses:
        "200":
          description: Session created
          content:
            application/json:
              schema:
                type: object
                properties:
                  sessionId:
                    type: string
                    format: uuid
                  expiresAt:
                    type: string
                    format: date-time
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          description: Invalid signature

  /relayer/move:
    post:
      tags: [Relayer]
      summary: Submit move via relayer
      description: Submit move for relayer to execute. Relayer builds and submits transaction on player's behalf.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [sessionId, matchId, moveType, moveSignature]
              properties:
                sessionId:
                  type: string
                  format: uuid
                matchId:
                  type: string
                  format: uuid
                moveType:
                  $ref: "#/components/schemas/MoveType"
                moveSignature:
                  type: string
                  description: Signature of the move data for verification
      responses:
        "200":
          description: Move submitted
          content:
            application/json:
              schema:
                type: object
                properties:
                  txId:
                    type: string
                    pattern: "^[a-f0-9]{64}$"
                  moveId:
                    type: string
                    format: uuid
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          description: Invalid or expired session
        "429":
          description: Rate limit exceeded
        "503":
          description: Relayer temporarily unavailable

  /relayer/status:
    get:
      tags: [Relayer]
      summary: Get relayer status
      description: Check relayer health and remaining capacity
      responses:
        "200":
          description: Relayer status
          content:
            application/json:
              schema:
                type: object
                properties:
                  available:
                    type: boolean
                  hotWalletBalance:
                    type: string
                    description: Available KAS for sponsoring
                  transactionsToday:
                    type: integer
                  dailyLimit:
                    type: integer

  # ============================================================================
  # LEADERBOARD
  # ============================================================================

  /leaderboard:
    get:
      tags: [Leaderboard]
      summary: Get global leaderboard
      parameters:
        - name: limit
          in: query
          schema:
            type: integer
            default: 50
            maximum: 100
        - name: offset
          in: query
          schema:
            type: integer
            default: 0
        - name: sortBy
          in: query
          schema:
            type: string
            enum: [wins, rating, winRate]
            default: wins
      responses:
        "200":
          description: Leaderboard entries
          content:
            application/json:
              schema:
                type: object
                properties:
                  entries:
                    type: array
                    items:
                      $ref: "#/components/schemas/LeaderboardEntry"
                  total:
                    type: integer
                  lastUpdated:
                    type: string
                    format: date-time

  # ============================================================================
  # PLAYERS
  # ============================================================================

  /players/{address}:
    get:
      tags: [Players]
      summary: Get player profile
      parameters:
        - name: address
          in: path
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Player profile
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Player"
        "404":
          description: Player not found

  /players/{address}/matches:
    get:
      tags: [Players]
      summary: Get player match history
      parameters:
        - name: address
          in: path
          required: true
          schema:
            type: string
        - name: limit
          in: query
          schema:
            type: integer
            default: 20
            maximum: 50
        - name: offset
          in: query
          schema:
            type: integer
            default: 0
      responses:
        "200":
          description: Match history
          content:
            application/json:
              schema:
                type: object
                properties:
                  matches:
                    type: array
                    items:
                      $ref: "#/components/schemas/MatchSummary"
                  total:
                    type: integer

  /players/{address}/display-name:
    put:
      tags: [Players]
      summary: Update display name
      parameters:
        - name: address
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [displayName, signature]
              properties:
                displayName:
                  type: string
                  minLength: 1
                  maxLength: 32
                  pattern: "^[a-zA-Z0-9_]+$"
                signature:
                  type: string
      responses:
        "200":
          description: Name updated
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "409":
          description: Display name already taken

  # ============================================================================
  # CHARACTERS
  # ============================================================================

  /characters:
    get:
      tags: [Game]
      summary: Get character roster
      responses:
        "200":
          description: Available characters
          content:
            application/json:
              schema:
                type: object
                properties:
                  characters:
                    type: array
                    items:
                      $ref: "#/components/schemas/Character"

# ==============================================================================
# COMPONENTS
# ==============================================================================

components:
  schemas:
    MoveType:
      type: string
      enum: [punch, kick, block, special]

    MatchFormat:
      type: string
      enum: [best_of_3, best_of_5]

    MatchStatus:
      type: string
      enum: [waiting, character_select, in_progress, completed]

    Player:
      type: object
      properties:
        address:
          type: string
        displayName:
          type: string
          nullable: true
        wins:
          type: integer
        losses:
          type: integer
        rating:
          type: integer
        createdAt:
          type: string
          format: date-time

    Character:
      type: object
      properties:
        id:
          type: string
        name:
          type: string
        theme:
          type: string
        portraitUrl:
          type: string
          format: uri

    Match:
      type: object
      properties:
        id:
          type: string
          format: uuid
        roomCode:
          type: string
          nullable: true
        player1:
          $ref: "#/components/schemas/MatchPlayer"
        player2:
          $ref: "#/components/schemas/MatchPlayer"
          nullable: true
        format:
          $ref: "#/components/schemas/MatchFormat"
        status:
          $ref: "#/components/schemas/MatchStatus"
        winnerAddress:
          type: string
          nullable: true
        currentRound:
          type: integer
        createdAt:
          type: string
          format: date-time

    MatchPlayer:
      type: object
      properties:
        address:
          type: string
        displayName:
          type: string
          nullable: true
        characterId:
          type: string
          nullable: true
        roundsWon:
          type: integer
        currentHealth:
          type: integer
        hasSubmittedMove:
          type: boolean

    Round:
      type: object
      properties:
        id:
          type: string
          format: uuid
        roundNumber:
          type: integer
        player1Move:
          $ref: "#/components/schemas/MoveType"
          nullable: true
        player2Move:
          $ref: "#/components/schemas/MoveType"
          nullable: true
        player1DamageDealt:
          type: integer
          nullable: true
        player2DamageDealt:
          type: integer
          nullable: true
        player1HealthAfter:
          type: integer
          nullable: true
        player2HealthAfter:
          type: integer
          nullable: true
        winnerAddress:
          type: string
          nullable: true
        txIds:
          type: object
          properties:
            player1:
              type: string
              nullable: true
            player2:
              type: string
              nullable: true

    RoomInfo:
      type: object
      properties:
        roomCode:
          type: string
        hostAddress:
          type: string
        hostDisplayName:
          type: string
          nullable: true
        format:
          $ref: "#/components/schemas/MatchFormat"
        status:
          $ref: "#/components/schemas/MatchStatus"
        isFull:
          type: boolean

    LeaderboardEntry:
      type: object
      properties:
        rank:
          type: integer
        address:
          type: string
        displayName:
          type: string
          nullable: true
        wins:
          type: integer
        losses:
          type: integer
        winRate:
          type: number
          format: float
        rating:
          type: integer

    MatchSummary:
      type: object
      properties:
        matchId:
          type: string
          format: uuid
        opponent:
          type: object
          properties:
            address:
              type: string
            displayName:
              type: string
              nullable: true
            characterId:
              type: string
        playerCharacterId:
          type: string
        result:
          type: string
          enum: [win, loss, forfeit_win, forfeit_loss]
        score:
          type: string
          example: "2-1"
        completedAt:
          type: string
          format: date-time
        explorerUrl:
          type: string
          format: uri
          description: Link to match transactions on Kaspa explorer

    Error:
      type: object
      properties:
        error:
          type: string
        message:
          type: string
        code:
          type: string

  responses:
    BadRequest:
      description: Invalid request parameters
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/Error"
    
    Unauthorized:
      description: Invalid or missing authentication
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/Error"
